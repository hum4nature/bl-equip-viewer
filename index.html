<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BL4 Equipment Editor</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/equipment.css">
    <link rel="stylesheet" href="css/customize-dialog.css">
    <link rel="stylesheet" href="css/str-weak.css">
    <link rel="stylesheet" href="css/notes.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Coda&family=Pridi:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap');
        
        :root {
            /* Font Variables */
            --maxroll-font-bl4: "Coda", system-ui;
            --maxroll-font-bl4-number: "Coda", system-ui;
            --maxroll-font-sans: "Source Sans 3", -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            
            /* BL4 Color Variables */
            --maxroll-bl4-color-level-4: 167, 200, 255;
            --maxroll-bl4-color-level-10: 194, 162, 255;
            --maxroll-bl4-color-level-20: 255, 234, 204;
            
            /* Color Variables */
            --maxroll-color-link: 0, 127, 172;
            --maxroll-color-dark-1: 0, 0, 0;
            --maxroll-color-dark-2: 28, 28, 28;
            --maxroll-color-dark-3: 10, 10, 10;
            --maxroll-color-dark-4: 23, 23, 23;
            --maxroll-color-dark-5: 43, 44, 44;
            --maxroll-color-dark-6: 18, 18, 18;
            --maxroll-color-white-1: 255, 255, 255;
            --maxroll-color-white-2: 218, 218, 218;
            --maxroll-color-grey-1: 149, 152, 155;
            --maxroll-color-grey-2: 128, 129, 145;
            --maxroll-color-grey-3: 115, 115, 115;
            --maxroll-color-grey-4: 92, 92, 92;
            --maxroll-color-blue: 5, 122, 240;
            --maxroll-color-blue-2: 53, 146, 255;
            --maxroll-color-purple: 184, 24, 240;
            --maxroll-color-orange: 240, 154, 24;
            --maxroll-color-red: 240, 5, 5;
            --maxroll-color-red-2: 133, 21, 34;
            --maxroll-color-green: 25, 159, 47;
            --maxroll-color-green-2: 33, 197, 19;
            
            /* Transition Variables */
            --maxroll-hover-transition-duration: 0.2s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #050b0d;
            color: rgb(136, 138, 156);
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 360px;
            min-width: 320px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 24px;
        }
        
        .header h1 {
            color: #fff;
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .edit-mode-toggle {
            margin-bottom: 24px;
        }
        
        .edit-mode-toggle button {
            background-color: #0b181e;
            color: rgb(136, 138, 156);
            border: 1px solid rgb(150, 148, 171);
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .edit-mode-toggle button:hover {
            background-color: rgb(150, 148, 171);
        }
        
        .edit-mode-toggle button.active {
            background-color: #5ec753;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Borderlands 4 - Equipment Editor</h1>
        </div>
        
        <div class="edit-mode-toggle">
            <button id="editModeToggle" class="active">Edit Mode: ON</button>
        </div>
        
        <!-- Equipment Section -->
        <div id="equipment-container" class="equipment equipment--editable">
            <!-- Will be populated by equipment.js -->
        </div>
        
        <!-- Strengths & Weaknesses Section -->
        <div id="str-weak-container" class="str-weak">
            <!-- Will be populated by str-weak-handler.js -->
        </div>
        
        <!-- Notes Section -->
        <div id="notes-container" class="notes">
            <!-- Will be populated by notes-handler.js -->
        </div>
    </div>
    
    <!-- Customize Dialog (hidden by default) -->
    <div id="customize-dialog" class="customize-dialog" style="display: none;">
        <!-- Will be populated by customize-dialog.js -->
    </div>
    
    <!-- Load game data first -->
    <script type="module" src="js/game-data.js"></script>
    
    <!-- Load utility functions -->
    <script type="module" src="js/utils.js"></script>
    
    <!-- Load handlers -->
    <script type="module" src="js/equipment.js"></script>
    <script type="module" src="js/customize-dialog.js"></script>
    <script type="module" src="js/select-dialog.js"></script>
    <script type="module" src="js/augment-selector.js"></script>
    <script type="module" src="js/str-weak-handler.js"></script>
    <script type="module" src="js/notes-handler.js"></script>
    <script type="module" src="js/firmware-handler.js"></script>
    
    <!-- Main app initialization -->
    <script type="module">
        import { loadGameData } from './js/game-data.js';
        import { Equipment } from './js/equipment.js';
        import CustomizeDialog from './js/customize-dialog.js';
        import { StrWeakHandler } from './js/str-weak-handler.js';
        import { NotesHandler } from './js/notes-handler.js';
        
        let gameData = null;
        let equipment = null;
        let customizeDialog = null;
        let strWeakHandler = null;
        let notesHandler = null;
        
        async function init() {
            console.log('[Init] Loading game data...');
            
            // Import state manager
            const { stateManager } = await import('./js/state-manager.js');
            
            try {
                gameData = await loadGameData();
                console.log('[Init] Game data loaded:', gameData);
                
                // Store gameData in state
                stateManager.setState({ gameData });
            } catch (error) {
                console.error('[Init] Failed to load game data:', error);
                // Continue with empty game data
                gameData = {
                    manufacturers: {},
                    elements: {},
                    itemAugments: {},
                    statAugments: {},
                    legendaryItemAugments: {},
                    firmwares: {},
                    weapons: {},
                    repkits: {},
                    ordnances: {},
                    'class-mods': {},
                    shields: {},
                    enhancements: {}
                };
                stateManager.setState({ gameData });
            }
            
            // Initialize equipment
            try {
                equipment = new Equipment('equipment-container', gameData);
                equipment.setEditable(true);
                console.log('[Init] Equipment initialized');
            } catch (error) {
                console.error('[Init] Failed to initialize equipment:', error);
                return;
            }
            
            // Initialize customize dialog
            try {
                customizeDialog = new CustomizeDialog('customize-dialog', gameData);
                console.log('[Init] Customize dialog initialized');
            } catch (error) {
                console.error('[Init] Failed to initialize customize dialog:', error);
                // Try to create it anyway - the error might be recoverable
                try {
                    customizeDialog = new CustomizeDialog('customize-dialog', gameData);
                    console.log('[Init] Customize dialog initialized on retry');
                } catch (e2) {
                    console.error('[Init] Dialog initialization completely failed:', e2);
                }
            }
            
            // Connect equipment to dialog - MUST happen after both are initialized
            if (equipment) {
                equipment.onSlotClick((slotId, currentItem) => {
                    console.log('[Init] Slot clicked, opening dialog:', slotId, 'Dialog available:', !!customizeDialog);
                    if (customizeDialog && typeof customizeDialog.open === 'function') {
                        customizeDialog.open(slotId, currentItem, (updatedItem) => {
                            console.log('[Init] Item saved, updating equipment:', slotId, updatedItem);
                            equipment.setItem(slotId, updatedItem);
                        });
                    } else {
                        console.error('[Init] Customize dialog not available or open method missing');
                    }
                });
                console.log('[Init] Slot click callback registered, callbacks count:', equipment.slotClickCallbacks.length);
            }
            
            // Initialize strengths/weaknesses
            try {
                strWeakHandler = new StrWeakHandler('str-weak-container', equipment);
            } catch (error) {
                console.error('Failed to initialize strengths/weaknesses:', error);
            }
            
            // Initialize notes
            try {
                notesHandler = new NotesHandler('notes-container');
            } catch (error) {
                console.error('Failed to initialize notes:', error);
            }
            
            // Override setItem to update strengths/weaknesses
            if (equipment) {
                const originalSetItem = equipment.setItem.bind(equipment);
                equipment.setItem = (slotId, item) => {
                    originalSetItem(slotId, item);
                    if (strWeakHandler) {
                        strWeakHandler.update();
                    }
                };
            }
            
            // Edit mode toggle
            const editToggle = document.getElementById('editModeToggle');
            if (editToggle && equipment) {
                editToggle.addEventListener('click', () => {
                    const isEditable = equipment.isEditable();
                    equipment.setEditable(!isEditable);
                    editToggle.textContent = `Edit Mode: ${!isEditable ? 'ON' : 'OFF'}`;
                    editToggle.classList.toggle('active', !isEditable);
                });
            }
            
            console.log('[Init] Equipment Editor initialized');
        }
        
        init().catch(console.error);
    </script>
</body>
</html>

